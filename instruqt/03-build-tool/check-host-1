#!/bin/bash
# Validation script for Challenge 3: Build Tool
# Checks that workflow tool exists and is properly configured

echo "=== Starting Challenge 3 Check Script ==="
echo "Date: $(date)"
echo ""

# Don't use set -e so we can see all errors
# set -e

echo "Step 1: Loading environment variables from kubernetes-vm:9000..."
ENV_RESPONSE=$(curl -s http://kubernetes-vm:9000/env 2>&1)
if [ $? -ne 0 ]; then
    echo "ERROR: Failed to fetch env vars from kubernetes-vm:9000"
    fail-message "ERROR: Could not load environment variables"
    exit 1
fi
echo "ENV_RESPONSE length: ${#ENV_RESPONSE}"

export $(echo "$ENV_RESPONSE" | xargs) 2>/dev/null || true

KIBANA_URL="${KIBANA_URL:-http://kubernetes-vm:30001}"
ES_APIKEY="${ELASTICSEARCH_APIKEY}"

echo "Step 2: Checking environment variables..."
echo "KIBANA_URL: $KIBANA_URL"
echo "ES_APIKEY set: $([ -n "$ES_APIKEY" ] && echo 'yes' || echo 'NO')"

if [ -z "$ES_APIKEY" ]; then
    echo "ERROR: ELASTICSEARCH_APIKEY is empty!"
    fail-message "ERROR: ELASTICSEARCH_APIKEY environment variable not set"
    exit 1
fi

echo ""
echo "Step 3: Fetching tools from Kibana..."
echo "URL: $KIBANA_URL/api/agent_builder/tools"

TOOL_RESPONSE=$(curl -s -w "\n%{http_code}" -X GET "$KIBANA_URL/api/agent_builder/tools" \
  -H "Authorization: ApiKey $ES_APIKEY" \
  -H "kbn-xsrf: true" \
  -H "x-elastic-internal-origin: kibana" 2>&1)

HTTP_CODE=$(echo "$TOOL_RESPONSE" | tail -n1)
RESPONSE_BODY=$(echo "$TOOL_RESPONSE" | sed '$d')

echo "HTTP Status: $HTTP_CODE"
echo "Response length: ${#RESPONSE_BODY}"

if [ "$HTTP_CODE" != "200" ]; then
    echo "ERROR: Kibana API returned non-200 status"
    echo "Response: $RESPONSE_BODY"
    fail-message "ERROR: Failed to query tools (HTTP $HTTP_CODE)"
    exit 1
fi

echo ""
echo "Step 4: Parsing tools response..."

# Debug: Show the structure of the response
echo "Response structure (first 500 chars):"
echo "$RESPONSE_BODY" | head -c 500
echo ""
echo ""

# Try to list all tool IDs - check both .data[] and direct array []
echo "Looking for tools..."
echo "Trying .data[] format:"
echo "$RESPONSE_BODY" | jq -r '.data[]? | .id' 2>/dev/null | head -10 || echo "  (no .data[] found)"

echo "Trying direct array [] format:"
echo "$RESPONSE_BODY" | jq -r '.[]? | .id' 2>/dev/null | head -10 || echo "  (no direct array found)"

echo "Trying .tools[] format:"
echo "$RESPONSE_BODY" | jq -r '.tools[]? | .id' 2>/dev/null | head -10 || echo "  (no .tools[] found)"

echo ""
echo "Step 5: Looking for tool-workflow-get-customer-profile..."

# Try different response formats
TOOL_DATA=""

# Try .data[] first
if echo "$RESPONSE_BODY" | jq -e '.data[] | select(.id=="tool-workflow-get-customer-profile")' > /dev/null 2>&1; then
    TOOL_DATA=$(echo "$RESPONSE_BODY" | jq '.data[] | select(.id=="tool-workflow-get-customer-profile")')
    echo "Found in .data[] format"
# Try direct array
elif echo "$RESPONSE_BODY" | jq -e '.[] | select(.id=="tool-workflow-get-customer-profile")' > /dev/null 2>&1; then
    TOOL_DATA=$(echo "$RESPONSE_BODY" | jq '.[] | select(.id=="tool-workflow-get-customer-profile")')
    echo "Found in direct array format"
# Try .tools[]
elif echo "$RESPONSE_BODY" | jq -e '.tools[] | select(.id=="tool-workflow-get-customer-profile")' > /dev/null 2>&1; then
    TOOL_DATA=$(echo "$RESPONSE_BODY" | jq '.tools[] | select(.id=="tool-workflow-get-customer-profile")')
    echo "Found in .tools[] format"
fi

if [ -n "$TOOL_DATA" ]; then
    echo ""
    echo "✓ Found tool: tool-workflow-get-customer-profile"
    
    # Verify it's a workflow tool
    TOOL_TYPE=$(echo "$TOOL_DATA" | jq -r '.type')
    if [ "$TOOL_TYPE" != "workflow" ]; then
        fail-message "ERROR: Tool type is '$TOOL_TYPE', expected 'workflow'"
        exit 1
    fi
    echo "✓ Tool type is correct: $TOOL_TYPE"
    
    # Verify workflow_id is configured
    WORKFLOW_ID=$(echo "$TOOL_DATA" | jq -r '.configuration.workflow_id // empty')
    if [ -z "$WORKFLOW_ID" ]; then
        fail-message "ERROR: Tool missing workflow_id in configuration"
        exit 1
    fi
    echo "✓ Tool configured with workflow_id: $WORKFLOW_ID"
    
    # Verify the workflow exists
    echo ""
    echo "Step 6: Verifying referenced workflow exists..."
    WORKFLOW_RESPONSE=$(curl -s -X POST "$KIBANA_URL/api/workflows/search" \
      -H "Authorization: ApiKey $ES_APIKEY" \
      -H "Content-Type: application/json" \
      -H "kbn-xsrf: true" \
      -H "x-elastic-internal-origin: kibana" \
      -d '{"limit": 100, "page": 1, "query": ""}')
    
    if echo "$WORKFLOW_RESPONSE" | jq -e ".results[] | select(.id==\"$WORKFLOW_ID\")" > /dev/null 2>&1; then
        WORKFLOW_NAME=$(echo "$WORKFLOW_RESPONSE" | jq -r ".results[] | select(.id==\"$WORKFLOW_ID\") | .name")
        echo "✓ Referenced workflow exists: $WORKFLOW_NAME"
    else
        fail-message "ERROR: Referenced workflow '$WORKFLOW_ID' does not exist"
        exit 1
    fi
    
    # Check description
    DESCRIPTION=$(echo "$TOOL_DATA" | jq -r '.description // empty')
    if [ -n "$DESCRIPTION" ]; then
        echo "✓ Tool has description: $DESCRIPTION"
    else
        echo "⚠ Warning: Tool missing description"
    fi
    
    echo ""
    echo "=== Challenge 3 Check PASSED ==="
    exit 0
else
    echo ""
    echo "ERROR: Tool 'tool-workflow-get-customer-profile' not found!"
    echo ""
    echo "Full response for debugging:"
    echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
    fail-message "ERROR: Tool 'tool-workflow-get-customer-profile' not found. Create it in Kibana → Agent Builder → Tools."
    exit 1
fi
