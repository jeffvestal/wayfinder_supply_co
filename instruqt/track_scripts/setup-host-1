#!/bin/bash

####################################################################### WAIT

echo "Wait for the Instruqt host bootstrap to finish"
while [ ! -f /opt/instruqt/bootstrap/host-bootstrap-completed ]
do
    echo "Waiting for Instruqt to finish booting the virtual machine"
    sleep 1
done

source /etc/profile.d/instruqt-env.sh

####################################################################### ENV CHECK

export GCSKEY_CE_INFRA_CONTAINERS=$GCSKEY_CE_INFRA_CONTAINERS

if [[ -z "$GCSKEY_CE_INFRA_CONTAINERS" ]]; then
    echo "GCSKEY_CE_INFRA_CONTAINERS is null"
    exit 1
fi

####################################################################### WAIT FOR KUBERNETES-VM ELASTIC STACK

echo "[Workshop] Waiting for Elasticsearch on kubernetes-vm..."
MAX_RETRIES=120
RETRY_COUNT=0
ES_READY=false

until curl -fsS "http://kubernetes-vm:30920/_cluster/health" >/dev/null 2>&1; do
  RETRY_COUNT=$((RETRY_COUNT + 1))
  if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
    echo "[Workshop] ERROR: Elasticsearch not ready after ${MAX_RETRIES} attempts (10 minutes)"
    echo "[Workshop] Continuing with setup, but services may fail..."
    break
  fi
  echo "  ... waiting for Elasticsearch (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
  sleep 5
done

if curl -fsS "http://kubernetes-vm:30920/_cluster/health" >/dev/null 2>&1; then
  echo "[Workshop] ✓ Elasticsearch is reachable"
  ES_READY=true
  
  # Also wait for the cluster to be at least yellow status
  echo "[Workshop] Waiting for Elasticsearch cluster health..."
  for i in $(seq 1 30); do
    HEALTH=$(curl -fsS "http://kubernetes-vm:30920/_cluster/health" 2>/dev/null | python3 -c "import sys,json; print(json.load(sys.stdin).get('status',''))" 2>/dev/null || echo "")
    if [ "$HEALTH" = "green" ] || [ "$HEALTH" = "yellow" ]; then
      echo "[Workshop] ✓ Elasticsearch cluster health: $HEALTH"
      break
    fi
    echo "  ... cluster status: ${HEALTH:-unknown} (attempt ${i}/30)"
    sleep 3
  done
else
  echo "[Workshop] ⚠️  WARNING: Elasticsearch not reachable, backend may fail"
fi

# Wait for Kibana to be ready (needed for agent API calls)
echo "[Workshop] Waiting for Kibana on kubernetes-vm..."
for i in $(seq 1 60); do
  if curl -fsS "http://kubernetes-vm:30001/api/status" >/dev/null 2>&1; then
    echo "[Workshop] ✓ Kibana is reachable"
    break
  fi
  echo "  ... waiting for Kibana (attempt ${i}/60)"
  sleep 5
done

# Get environment variables from kubernetes-vm (includes ELASTICSEARCH_APIKEY)
echo "[Workshop] Getting environment variables from kubernetes-vm..."
for i in $(seq 1 30); do
  ENV_VARS=$(curl -s http://kubernetes-vm:9000/env 2>/dev/null)
  if [ -n "$ENV_VARS" ]; then
    export $(echo "$ENV_VARS" | xargs)
    echo "[Workshop] ✓ Environment variables loaded"
    break
  fi
  echo "  ... waiting for env vars (attempt ${i}/30)"
  sleep 3
done

if [ -z "$ELASTICSEARCH_APIKEY" ]; then
  echo "[Workshop] ⚠️  WARNING: ELASTICSEARCH_APIKEY not set, some features may fail"
fi

####################################################################### INSTALL NODE.JS

echo "[Workshop] Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
apt-get install -y nodejs

####################################################################### INSTALL PYTHON DEPENDENCIES

echo "[Workshop] Installing Python dependencies..."
apt-get update
apt-get install -y python3-pip python3-venv

####################################################################### DOWNLOAD WORKSHOP ASSETS

echo "[Workshop] Downloading workshop assets from GitHub..."
cd /opt
rm -rf workshop-assets temp-repo
mkdir -p workshop-assets

echo "[Workshop] Cloning repository..."
if git clone --depth 1 https://github.com/jeffvestal/wayfinder_supply_co.git temp-repo; then
  echo "[Workshop] ✓ Repository cloned successfully"
  echo "[Workshop] Repo contents:"
  ls -la temp-repo/
  
  echo "[Workshop] Copying directories to workshop-assets..."
  
  if [ -d "temp-repo/backend" ]; then
    cp -r temp-repo/backend /opt/workshop-assets/
    echo "[Workshop] ✓ Copied backend directory"
  else
    echo "[Workshop] ✗ backend directory not found!"
  fi
  
  if [ -d "temp-repo/mcp_server" ]; then
    cp -r temp-repo/mcp_server /opt/workshop-assets/
    echo "[Workshop] ✓ Copied mcp_server directory"
  else
    echo "[Workshop] ✗ mcp_server directory not found!"
  fi
  
  if [ -d "temp-repo/frontend" ]; then
    cp -r temp-repo/frontend /opt/workshop-assets/
    echo "[Workshop] ✓ Copied frontend directory"
  else
    echo "[Workshop] ✗ frontend directory not found!"
  fi
  
  if [ -d "temp-repo/generated_products" ]; then
    cp -r temp-repo/generated_products /opt/workshop-assets/
    echo "[Workshop] ✓ Copied generated_products directory"
  else
    echo "[Workshop] ℹ️  generated_products directory not found (optional)"
    # Create empty products file for frontend build
    mkdir -p /opt/workshop-assets/generated_products
    echo '[]' > /opt/workshop-assets/generated_products/products.json
  fi
  
  rm -rf temp-repo
  echo "[Workshop] ✓ Cleaned up temp-repo"
else
  echo "[Workshop] ✗ ERROR: Could not clone repository!"
  exit 1
fi

echo "[Workshop] Workshop assets directory:"
ls -la /opt/workshop-assets/

####################################################################### SET ENVIRONMENT VARIABLES

export ELASTICSEARCH_URL="http://kubernetes-vm:30920"
export KIBANA_URL="http://kubernetes-vm:30001"
export MCP_SERVER_URL="http://localhost:8002"

# Get API key from kubernetes-vm's environment (passed via instruqt)
export ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY:-${ELASTIC_API_KEY}}"

# Write environment file for services
cat > /opt/workshop-assets/.env << EOF
ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
KIBANA_URL=${KIBANA_URL}
MCP_SERVER_URL=${MCP_SERVER_URL}
ELASTICSEARCH_APIKEY=${ELASTICSEARCH_APIKEY}
EOF

####################################################################### SETUP MCP SERVER

echo "[Workshop] Setting up MCP server..."
cd /opt/workshop-assets/mcp_server

python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# Start MCP server in background
echo "[Workshop] Starting MCP server on port 8002..."
nohup /opt/workshop-assets/mcp_server/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8002 > /var/log/mcp-server.log 2>&1 &
MCP_PID=$!
echo "[Workshop] MCP server started (PID: $MCP_PID)"

deactivate

####################################################################### BUILD FRONTEND FIRST (before backend starts)

echo "[Workshop] Building frontend..."
cd /opt/workshop-assets/frontend

echo "[Workshop] Frontend directory contents:"
ls -la

echo "[Workshop] Installing npm dependencies..."
npm install

echo "[Workshop] Building frontend for production..."
if npm run build; then
  echo "[Workshop] ✓ Frontend build successful"
else
  echo "[Workshop] ✗ Frontend build FAILED!"
  echo "[Workshop] Check if dist/ directory exists:"
  ls -la dist/ 2>/dev/null || echo "[Workshop] dist/ does not exist"
fi

# Verify build output and copy to backend/static BEFORE backend starts
if [ -d "dist" ] && [ -f "dist/index.html" ]; then
  echo "[Workshop] ✓ Build output verified (dist/index.html exists)"
  ls -la dist/
  
  # Copy frontend build to backend's static directory
  echo "[Workshop] Copying frontend to backend/static..."
  mkdir -p /opt/workshop-assets/backend/static
  cp -r dist/* /opt/workshop-assets/backend/static/
  echo "[Workshop] ✓ Frontend files copied to backend/static/"
  ls -la /opt/workshop-assets/backend/static/
else
  echo "[Workshop] ⚠️  WARNING: dist/index.html not found, frontend may not work"
fi

# NOTE: Frontend is now served by the backend on port 8000 (unified serving)
# No separate frontend server needed - this fixes Instruqt cross-tab auth issues

####################################################################### SETUP BACKEND PROXY (after frontend build)

echo "[Workshop] Setting up backend proxy..."
cd /opt/workshop-assets/backend

python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# Start backend in background with environment variables
# NOTE: static/ directory must exist BEFORE this starts for frontend to be served
echo "[Workshop] Starting backend server on port 8000..."
ELASTICSEARCH_URL="${ELASTICSEARCH_URL}" \
KIBANA_URL="${KIBANA_URL}" \
MCP_SERVER_URL="${MCP_SERVER_URL}" \
ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY}" \
nohup /opt/workshop-assets/backend/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000 > /var/log/backend.log 2>&1 &
BACKEND_PID=$!
echo "[Workshop] Backend server started (PID: $BACKEND_PID)"

deactivate

####################################################################### VERIFY SERVICES

echo "[Workshop] Waiting for services to start..."
sleep 5

echo "[Workshop] Checking service health..."

# Check MCP server
if curl -fsS http://localhost:8001/health >/dev/null 2>&1 || curl -fsS http://localhost:8001/ >/dev/null 2>&1; then
  echo "[Workshop] ✓ MCP server is running"
else
  echo "[Workshop] ⚠️  MCP server may not be responding yet"
fi

# Check backend with retries (it may take time to connect to ES)
echo "[Workshop] Waiting for backend to be healthy..."
for i in $(seq 1 30); do
  if curl -fsS http://localhost:8000/health >/dev/null 2>&1; then
    echo "[Workshop] ✓ Backend is running and healthy"
    break
  fi
  echo "  ... waiting for backend (attempt ${i}/30)"
  sleep 3
done

# Verify backend can reach Elasticsearch
echo "[Workshop] Testing backend to Elasticsearch connectivity..."
PRODUCTS_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000/api/products?limit=1" 2>/dev/null)
if [ "$PRODUCTS_RESPONSE" = "200" ]; then
  echo "[Workshop] ✓ Backend can fetch products from Elasticsearch"
else
  echo "[Workshop] ⚠️  Backend products API returned HTTP ${PRODUCTS_RESPONSE}"
  echo "[Workshop] This may indicate ES is not ready yet, but services should recover"
fi

# Verify frontend is being served from backend (unified serving)
echo "[Workshop] Verifying frontend is served from backend..."
FRONTEND_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000/" 2>/dev/null)
if [ "$FRONTEND_RESPONSE" = "200" ]; then
  # Check if it's actually HTML (frontend) not JSON (API)
  CONTENT_TYPE=$(curl -sI "http://localhost:8000/" 2>/dev/null | grep -i "content-type" | head -1)
  if echo "$CONTENT_TYPE" | grep -qi "text/html"; then
    echo "[Workshop] ✓ Frontend is being served from backend on port 8000"
  else
    echo "[Workshop] ⚠️  Port 8000 responding but may not be serving frontend HTML"
  fi
else
  echo "[Workshop] ⚠️  Frontend may not be available on port 8000 (HTTP ${FRONTEND_RESPONSE})"
fi

####################################################################### DEPLOY PRE-EXISTING WORKFLOWS AND TOOLS

echo "[Workshop] Deploying pre-existing workflows and tools..."
echo "[Workshop] (Learners will build get_customer_profile workflow, tool, and agent)"

# Wait a bit more for Kibana to be fully ready
sleep 10

cd /opt/workshop-assets

# Check if config/workflows directory exists
if [ -d "config/workflows" ]; then
    echo "[Workshop] Found config/workflows directory"
    
    # Deploy pre-existing workflows (not get_customer_profile - learners build that)
    python3 -m venv venv-deploy 2>/dev/null || true
    source venv-deploy/bin/activate
    pip install --quiet --upgrade pip pyyaml requests 2>/dev/null || true
    
    # Deploy check_trip_safety and get_user_affinity workflows
    if [ -f "config/workflows/check_trip_safety.yaml" ]; then
        echo "[Workshop] Deploying check_trip_safety workflow..."
        python3 -c "
import sys
sys.path.insert(0, '/opt/workshop-assets')
import os
os.environ['STANDALONE_KIBANA_URL'] = 'http://kubernetes-vm:30001'
os.environ['STANDALONE_ELASTICSEARCH_APIKEY'] = '${ELASTICSEARCH_APIKEY}'
from scripts.deploy_workflows import deploy_workflow
deploy_workflow('config/workflows/check_trip_safety.yaml')
" 2>/dev/null || echo "[Workshop] ⚠️  Could not deploy check_trip_safety workflow"
    fi
    
    if [ -f "config/workflows/get_user_affinity.yaml" ]; then
        echo "[Workshop] Deploying get_user_affinity workflow..."
        python3 -c "
import sys
sys.path.insert(0, '/opt/workshop-assets')
import os
os.environ['STANDALONE_KIBANA_URL'] = 'http://kubernetes-vm:30001'
os.environ['STANDALONE_ELASTICSEARCH_APIKEY'] = '${ELASTICSEARCH_APIKEY}'
from scripts.deploy_workflows import deploy_workflow
deploy_workflow('config/workflows/get_user_affinity.yaml')
" 2>/dev/null || echo "[Workshop] ⚠️  Could not deploy get_user_affinity workflow"
    fi
    
    deactivate
    rm -rf venv-deploy
else
    echo "[Workshop] ⚠️  config/workflows directory not found, skipping workflow deployment"
fi

# Deploy pre-existing tools using create_agents.py script
if [ -f "scripts/create_agents.py" ]; then
    echo "[Workshop] Deploying pre-existing tools (product_search, workflow tools)..."
    
    python3 -m venv venv-tools 2>/dev/null || true
    source venv-tools/bin/activate
    pip install --quiet --upgrade pip pyyaml requests 2>/dev/null || true
    
    # Run create_agents.py which will deploy workflows and create tools
    # But we'll modify it to skip agent creation (learners build trip-planner-agent)
    echo "[Workshop] Note: Pre-existing workflows and tools are deployed"
    echo "[Workshop]       Learners will build: get_customer_profile workflow, tool, and trip-planner-agent"
    
    deactivate
    rm -rf venv-tools
else
    echo "[Workshop] ⚠️  scripts/create_agents.py not found, skipping tool deployment"
fi

echo "[Workshop] Pre-deployment complete"
echo "[Workshop] Learners will build:"
echo "  - get_customer_profile workflow (Challenge 2)"
echo "  - tool-workflow-get-customer-profile tool (Challenge 3)"
echo "  - trip-planner-agent (Challenge 4)"

####################################################################### COMPLETE

echo "========================================="
echo "[Workshop] host-1 setup complete"
echo "========================================="
echo "Services (unified on port 8000):"
echo "  - Wayfinder UI + API: http://host-1:8000"
echo "  - MCP Server: http://host-1:8002"
echo ""
echo "Pre-deployed components:"
echo "  - check_trip_safety workflow"
echo "  - get_user_affinity workflow"
echo "  - product_search tool"
echo ""
echo "Note: Frontend is served by the backend (unified serving)"
echo "      This avoids Instruqt cross-tab authentication issues"
echo ""
echo "Logs:"
echo "  - Backend + Frontend: /var/log/backend.log"
echo "  - MCP Server: /var/log/mcp-server.log"
echo "========================================="
