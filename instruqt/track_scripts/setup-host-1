#!/bin/bash

####################################################################### WAIT

echo "Wait for the Instruqt host bootstrap to finish"
while [ ! -f /opt/instruqt/bootstrap/host-bootstrap-completed ]
do
    echo "Waiting for Instruqt to finish booting the virtual machine"
    sleep 1
done

source /etc/profile.d/instruqt-env.sh

####################################################################### ENV CHECK

export GCSKEY_CE_INFRA_CONTAINERS=$GCSKEY_CE_INFRA_CONTAINERS

if [[ -z "$GCSKEY_CE_INFRA_CONTAINERS" ]]; then
    echo "GCSKEY_CE_INFRA_CONTAINERS is null"
    exit 1
fi

####################################################################### INSTALL NODE.JS

echo "[Workshop] Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
apt-get install -y nodejs

####################################################################### INSTALL PYTHON DEPENDENCIES

echo "[Workshop] Installing Python dependencies..."
apt-get update
apt-get install -y python3-pip python3-venv

####################################################################### DOWNLOAD WORKSHOP ASSETS

echo "[Workshop] Downloading workshop assets from GitHub..."
cd /opt
rm -rf workshop-assets temp-repo
mkdir -p workshop-assets

echo "[Workshop] Cloning repository..."
if git clone --depth 1 https://github.com/jeffvestal/wayfinder_supply_co.git temp-repo; then
  echo "[Workshop] ✓ Repository cloned successfully"
  echo "[Workshop] Repo contents:"
  ls -la temp-repo/
  
  echo "[Workshop] Copying directories to workshop-assets..."
  
  if [ -d "temp-repo/backend" ]; then
    cp -r temp-repo/backend /opt/workshop-assets/
    echo "[Workshop] ✓ Copied backend directory"
  else
    echo "[Workshop] ✗ backend directory not found!"
  fi
  
  if [ -d "temp-repo/mcp_server" ]; then
    cp -r temp-repo/mcp_server /opt/workshop-assets/
    echo "[Workshop] ✓ Copied mcp_server directory"
  else
    echo "[Workshop] ✗ mcp_server directory not found!"
  fi
  
  if [ -d "temp-repo/frontend" ]; then
    cp -r temp-repo/frontend /opt/workshop-assets/
    echo "[Workshop] ✓ Copied frontend directory"
  else
    echo "[Workshop] ✗ frontend directory not found!"
  fi
  
  if [ -d "temp-repo/generated_products" ]; then
    cp -r temp-repo/generated_products /opt/workshop-assets/
    echo "[Workshop] ✓ Copied generated_products directory"
  else
    echo "[Workshop] ℹ️  generated_products directory not found (optional)"
    # Create empty products file for frontend build
    mkdir -p /opt/workshop-assets/generated_products
    echo '[]' > /opt/workshop-assets/generated_products/products.json
  fi
  
  rm -rf temp-repo
  echo "[Workshop] ✓ Cleaned up temp-repo"
else
  echo "[Workshop] ✗ ERROR: Could not clone repository!"
  exit 1
fi

echo "[Workshop] Workshop assets directory:"
ls -la /opt/workshop-assets/

####################################################################### SET ENVIRONMENT VARIABLES

export ELASTICSEARCH_URL="http://kubernetes-vm:30920"
export KIBANA_URL="http://kubernetes-vm:30001"
export MCP_SERVER_URL="http://localhost:8002"

# Get API key from kubernetes-vm's environment (passed via instruqt)
export ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY:-${ELASTIC_API_KEY}}"

# Write environment file for services
cat > /opt/workshop-assets/.env << EOF
ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
KIBANA_URL=${KIBANA_URL}
MCP_SERVER_URL=${MCP_SERVER_URL}
ELASTICSEARCH_APIKEY=${ELASTICSEARCH_APIKEY}
EOF

####################################################################### SETUP MCP SERVER

echo "[Workshop] Setting up MCP server..."
cd /opt/workshop-assets/mcp_server

python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# Start MCP server in background
echo "[Workshop] Starting MCP server on port 8002..."
nohup /opt/workshop-assets/mcp_server/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8002 > /var/log/mcp-server.log 2>&1 &
MCP_PID=$!
echo "[Workshop] MCP server started (PID: $MCP_PID)"

deactivate

####################################################################### BUILD FRONTEND FIRST (before backend starts)

echo "[Workshop] Building frontend..."
cd /opt/workshop-assets/frontend

echo "[Workshop] Frontend directory contents:"
ls -la

echo "[Workshop] Installing npm dependencies..."
npm install

echo "[Workshop] Building frontend for production..."
if npm run build; then
  echo "[Workshop] ✓ Frontend build successful"
else
  echo "[Workshop] ✗ Frontend build FAILED!"
  echo "[Workshop] Check if dist/ directory exists:"
  ls -la dist/ 2>/dev/null || echo "[Workshop] dist/ does not exist"
fi

# Verify build output and copy to backend/static BEFORE backend starts
if [ -d "dist" ] && [ -f "dist/index.html" ]; then
  echo "[Workshop] ✓ Build output verified (dist/index.html exists)"
  ls -la dist/
  
  # Copy frontend build to backend's static directory
  echo "[Workshop] Copying frontend to backend/static..."
  mkdir -p /opt/workshop-assets/backend/static
  cp -r dist/* /opt/workshop-assets/backend/static/
  echo "[Workshop] ✓ Frontend files copied to backend/static/"
  ls -la /opt/workshop-assets/backend/static/
else
  echo "[Workshop] ⚠️  WARNING: dist/index.html not found, frontend may not work"
fi

# NOTE: Frontend is now served by the backend on port 8000 (unified serving)
# No separate frontend server needed - this fixes Instruqt cross-tab auth issues

####################################################################### SETUP BACKEND PROXY (after frontend build)

echo "[Workshop] Setting up backend proxy..."
cd /opt/workshop-assets/backend

python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# Start backend in background with environment variables
# NOTE: static/ directory must exist BEFORE this starts for frontend to be served
echo "[Workshop] Starting backend server on port 8000..."
ELASTICSEARCH_URL="${ELASTICSEARCH_URL}" \
KIBANA_URL="${KIBANA_URL}" \
MCP_SERVER_URL="${MCP_SERVER_URL}" \
ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY}" \
nohup /opt/workshop-assets/backend/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000 > /var/log/backend.log 2>&1 &
BACKEND_PID=$!
echo "[Workshop] Backend server started (PID: $BACKEND_PID)"

deactivate

####################################################################### VERIFY SERVICES

echo "[Workshop] Waiting for services to start..."
sleep 5

echo "[Workshop] Checking service health..."

# Check MCP server
if curl -fsS http://localhost:8002/health >/dev/null 2>&1 || curl -fsS http://localhost:8002/ >/dev/null 2>&1; then
  echo "[Workshop] ✓ MCP server is running"
else
  echo "[Workshop] ⚠️  MCP server may not be responding yet"
fi

# Check backend with retries (it may take time to connect to ES)
echo "[Workshop] Waiting for backend to be healthy..."
for i in $(seq 1 30); do
  if curl -fsS http://localhost:8000/health >/dev/null 2>&1; then
    echo "[Workshop] ✓ Backend is running and healthy"
    break
  fi
  echo "  ... waiting for backend (attempt ${i}/30)"
  sleep 3
done

# Verify backend can reach Elasticsearch
echo "[Workshop] Testing backend to Elasticsearch connectivity..."
PRODUCTS_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000/api/products?limit=1" 2>/dev/null)
if [ "$PRODUCTS_RESPONSE" = "200" ]; then
  echo "[Workshop] ✓ Backend can fetch products from Elasticsearch"
else
  echo "[Workshop] ⚠️  Backend products API returned HTTP ${PRODUCTS_RESPONSE}"
  echo "[Workshop] This may indicate ES is not ready yet, but services should recover"
fi

# Verify frontend is being served from backend (unified serving)
echo "[Workshop] Verifying frontend is served from backend..."
FRONTEND_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8000/" 2>/dev/null)
if [ "$FRONTEND_RESPONSE" = "200" ]; then
  # Check if it's actually HTML (frontend) not JSON (API)
  CONTENT_TYPE=$(curl -sI "http://localhost:8000/" 2>/dev/null | grep -i "content-type" | head -1)
  if echo "$CONTENT_TYPE" | grep -qi "text/html"; then
    echo "[Workshop] ✓ Frontend is being served from backend on port 8000"
  else
    echo "[Workshop] ⚠️  Port 8000 responding but may not be serving frontend HTML"
  fi
else
  echo "[Workshop] ⚠️  Frontend may not be available on port 8000 (HTTP ${FRONTEND_RESPONSE})"
fi

####################################################################### COMPLETE

echo "========================================="
echo "[Workshop] host-1 setup complete"
echo "========================================="
echo "Services (unified on port 8000):"
echo "  - Wayfinder UI + API: http://host-1:8000"
echo "  - MCP Server: http://host-1:8002"
echo ""
echo "Note: Workflows and tools are deployed by kubernetes-vm"
echo ""
echo "Note: Frontend is served by the backend (unified serving)"
echo "      This avoids Instruqt cross-tab authentication issues"
echo ""
echo "Logs:"
echo "  - Backend + Frontend: /var/log/backend.log"
echo "  - MCP Server: /var/log/mcp-server.log"
echo "========================================="
