#!/bin/bash

####################################################################### WAIT

echo "Wait for the Instruqt host bootstrap to finish"
while [ ! -f /opt/instruqt/bootstrap/host-bootstrap-completed ]
do
    echo "Waiting for Instruqt to finish booting the virtual machine"
    sleep 1
done

source /etc/profile.d/instruqt-env.sh

####################################################################### ENV CHECK

export GCSKEY_CE_INFRA_CONTAINERS=$GCSKEY_CE_INFRA_CONTAINERS

if [[ -z "$GCSKEY_CE_INFRA_CONTAINERS" ]]; then
    echo "GCSKEY_CE_INFRA_CONTAINERS is null"
    exit 1
fi

####################################################################### WAIT FOR KUBERNETES-VM ELASTIC STACK

echo "[Workshop] Waiting for Elasticsearch on kubernetes-vm..."
MAX_RETRIES=60
RETRY_COUNT=0

until curl -fsS "http://kubernetes-vm:30920/_cluster/health" >/dev/null 2>&1; do
  RETRY_COUNT=$((RETRY_COUNT + 1))
  if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
    echo "[Workshop] WARNING: Elasticsearch not ready, continuing anyway..."
    break
  fi
  echo "  ... waiting for Elasticsearch (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
  sleep 5
done

echo "[Workshop] ✓ Elasticsearch is reachable"

# Get environment variables from kubernetes-vm (includes ELASTICSEARCH_APIKEY)
echo "[Workshop] Getting environment variables from kubernetes-vm..."
export $(curl -s http://kubernetes-vm:9000/env | xargs)
echo "[Workshop] ✓ Environment variables loaded"

####################################################################### INSTALL NODE.JS

echo "[Workshop] Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
apt-get install -y nodejs

####################################################################### INSTALL PYTHON DEPENDENCIES

echo "[Workshop] Installing Python dependencies..."
apt-get update
apt-get install -y python3-pip python3-venv

####################################################################### DOWNLOAD WORKSHOP ASSETS

echo "[Workshop] Downloading workshop assets from GitHub..."
cd /opt
rm -rf workshop-assets temp-repo
mkdir -p workshop-assets

echo "[Workshop] Cloning repository..."
if git clone --depth 1 https://github.com/jeffvestal/wayfinder_supply_co.git temp-repo; then
  echo "[Workshop] ✓ Repository cloned successfully"
  echo "[Workshop] Repo contents:"
  ls -la temp-repo/
  
  echo "[Workshop] Copying directories to workshop-assets..."
  
  if [ -d "temp-repo/backend" ]; then
    cp -r temp-repo/backend /opt/workshop-assets/
    echo "[Workshop] ✓ Copied backend directory"
  else
    echo "[Workshop] ✗ backend directory not found!"
  fi
  
  if [ -d "temp-repo/mcp_server" ]; then
    cp -r temp-repo/mcp_server /opt/workshop-assets/
    echo "[Workshop] ✓ Copied mcp_server directory"
  else
    echo "[Workshop] ✗ mcp_server directory not found!"
  fi
  
  if [ -d "temp-repo/frontend" ]; then
    cp -r temp-repo/frontend /opt/workshop-assets/
    echo "[Workshop] ✓ Copied frontend directory"
  else
    echo "[Workshop] ✗ frontend directory not found!"
  fi
  
  if [ -d "temp-repo/generated_products" ]; then
    cp -r temp-repo/generated_products /opt/workshop-assets/
    echo "[Workshop] ✓ Copied generated_products directory"
  else
    echo "[Workshop] ℹ️  generated_products directory not found (optional)"
    # Create empty products file for frontend build
    mkdir -p /opt/workshop-assets/generated_products
    echo '[]' > /opt/workshop-assets/generated_products/products.json
  fi
  
  rm -rf temp-repo
  echo "[Workshop] ✓ Cleaned up temp-repo"
else
  echo "[Workshop] ✗ ERROR: Could not clone repository!"
  exit 1
fi

echo "[Workshop] Workshop assets directory:"
ls -la /opt/workshop-assets/

####################################################################### SET ENVIRONMENT VARIABLES

export ELASTICSEARCH_URL="http://kubernetes-vm:30920"
export KIBANA_URL="http://kubernetes-vm:30001"
export MCP_SERVER_URL="http://localhost:8001"

# Get API key from kubernetes-vm's environment (passed via instruqt)
export ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY:-${ELASTIC_API_KEY}}"

# Write environment file for services
cat > /opt/workshop-assets/.env << EOF
ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
KIBANA_URL=${KIBANA_URL}
MCP_SERVER_URL=${MCP_SERVER_URL}
ELASTICSEARCH_APIKEY=${ELASTICSEARCH_APIKEY}
EOF

####################################################################### SETUP MCP SERVER

echo "[Workshop] Setting up MCP server..."
cd /opt/workshop-assets/mcp_server

python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# Start MCP server in background
echo "[Workshop] Starting MCP server on port 8001..."
nohup /opt/workshop-assets/mcp_server/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8001 > /var/log/mcp-server.log 2>&1 &
MCP_PID=$!
echo "[Workshop] MCP server started (PID: $MCP_PID)"

deactivate

####################################################################### SETUP BACKEND PROXY

echo "[Workshop] Setting up backend proxy..."
cd /opt/workshop-assets/backend

python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# Start backend in background with environment variables
echo "[Workshop] Starting backend server on port 8000..."
ELASTICSEARCH_URL="${ELASTICSEARCH_URL}" \
KIBANA_URL="${KIBANA_URL}" \
MCP_SERVER_URL="${MCP_SERVER_URL}" \
ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY}" \
nohup /opt/workshop-assets/backend/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000 > /var/log/backend.log 2>&1 &
BACKEND_PID=$!
echo "[Workshop] Backend server started (PID: $BACKEND_PID)"

deactivate

####################################################################### SETUP FRONTEND

echo "[Workshop] Setting up frontend..."
cd /opt/workshop-assets/frontend

echo "[Workshop] Frontend directory contents:"
ls -la

echo "[Workshop] Installing npm dependencies..."
npm install

echo "[Workshop] Building frontend for production..."
if npm run build; then
  echo "[Workshop] ✓ Frontend build successful"
else
  echo "[Workshop] ✗ Frontend build FAILED!"
  echo "[Workshop] Check if dist/ directory exists:"
  ls -la dist/ 2>/dev/null || echo "[Workshop] dist/ does not exist"
fi

# Verify build output
if [ -d "dist" ] && [ -f "dist/index.html" ]; then
  echo "[Workshop] ✓ Build output verified (dist/index.html exists)"
  ls -la dist/
else
  echo "[Workshop] ⚠️  WARNING: dist/index.html not found, frontend may not work"
fi

# Install and start serve for static files
npm install -g serve
echo "[Workshop] Starting frontend on port 3000..."
nohup serve -s dist -l 3000 > /var/log/frontend.log 2>&1 &
FRONTEND_PID=$!
echo "[Workshop] Frontend server started (PID: $FRONTEND_PID)"

####################################################################### VERIFY SERVICES

echo "[Workshop] Waiting for services to start..."
sleep 5

echo "[Workshop] Checking service health..."

# Check MCP server
if curl -fsS http://localhost:8001/health >/dev/null 2>&1 || curl -fsS http://localhost:8001/ >/dev/null 2>&1; then
  echo "[Workshop] ✓ MCP server is running"
else
  echo "[Workshop] ⚠️  MCP server may not be responding yet"
fi

# Check backend
if curl -fsS http://localhost:8000/health >/dev/null 2>&1 || curl -fsS http://localhost:8000/ >/dev/null 2>&1; then
  echo "[Workshop] ✓ Backend is running"
else
  echo "[Workshop] ⚠️  Backend may not be responding yet"
fi

# Check frontend
if curl -fsS http://localhost:3000/ >/dev/null 2>&1; then
  echo "[Workshop] ✓ Frontend is running"
else
  echo "[Workshop] ⚠️  Frontend may not be responding yet"
fi

####################################################################### COMPLETE

echo "========================================="
echo "[Workshop] host-1 setup complete"
echo "========================================="
echo "Services:"
echo "  - MCP Server: http://host-1:8001"
echo "  - Backend API: http://host-1:8000"
echo "  - Frontend: http://host-1:3000"
echo ""
echo "Logs:"
echo "  - MCP Server: /var/log/mcp-server.log"
echo "  - Backend: /var/log/backend.log"
echo "  - Frontend: /var/log/frontend.log"
echo "========================================="
